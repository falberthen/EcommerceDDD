# Kiota client regeneration tools
# Loaded automatically by Docker Compose alongside docker-compose.yml â€” no extra flags needed.
# Requires the main stack to be running: docker compose up -d
#
# Usage:
#   docker compose --profile tools run regenerate-clients          # backend + frontend
#   docker compose --profile tools run regenerate-backend-clients  # backend only (C#)
#   docker compose --profile tools run regenerate-frontend-clients # frontend only (TypeScript)

x-kiota-tool: &kiota-tool
  image: mcr.microsoft.com/dotnet/sdk:10.0
  profiles: ["tools"]
  working_dir: /src
  volumes:
    - ./src:/src
    - ./scripts:/scripts
  environment:
    - DOTNET_NOLOGO=1

services:
  regenerate-clients:
    <<: *kiota-tool
    entrypoint: >
      bash -c "
        dotnet tool install -g Microsoft.OpenApi.Kiota 2>/dev/null || true &&
        export PATH=\"$$PATH:/root/.dotnet/tools\" &&
        tr -d '\\015' < /scripts/regenerate-clients.sh | bash -s -- all"

  regenerate-backend-clients:
    <<: *kiota-tool
    entrypoint: >
      bash -c "
        dotnet tool install -g Microsoft.OpenApi.Kiota 2>/dev/null || true &&
        export PATH=\"$$PATH:/root/.dotnet/tools\" &&
        tr -d '\\015' < /scripts/regenerate-clients.sh | bash -s -- backend"

  regenerate-frontend-clients:
    <<: *kiota-tool
    entrypoint: >
      bash -c "
        dotnet tool install -g Microsoft.OpenApi.Kiota 2>/dev/null || true &&
        export PATH=\"$$PATH:/root/.dotnet/tools\" &&
        tr -d '\\015' < /scripts/regenerate-clients.sh | bash -s -- frontend"
